#!/bin/bash

echo "STEP 1: Create VM"
echo "Creating disk {{diskName}} with size of {{diskSize}} MB.."
VBoxManage createmedium --filename {{hardDiskPath}}.vdi --size {{diskSize}} --format VDI
echo "Creating Windows 10 Virtual Machine"
echo "Name: {{name}}"
echo "RAM size: {{ramSize}} MB"
echo "Processors: {{cpuCores}}"
VBoxManage createvm --name "{{name}}" --basefolder {{projectPath}} --ostype Windows10_64 --uuid {{dmiSystemUuid}} --register
VBoxManage modifyvm "{{name}}" --ioapic on
VBoxManage modifyvm "{{name}}" --memory {{ramSize}} --vram 128 --cpus {{cpuCores}}
echo "Adding SATA controller to {{name}} VM"
VBoxManage storagectl "{{name}}" --name "SATA" --add sata --controller IntelAhci --portcount 3
echo "Registering {{hardDiskPath}}.vdi to {{name}} VM"
VBoxManage storageattach "{{name}}" --storagectl "SATA" --port 0 --type hdd --medium {{hardDiskPath}}.vdi
echo "Mount Windows 10 ISO to VM"
VBoxManage storageattach "{{name}}" --storagectl "SATA" --port 1 --type dvddrive --medium {{windowsIsoPath}}
echo "Setting machine values for hardening"
{{projectPath}}/vbox_script.sh
echo "Running {{name}}"
VBoxManage startvm "{{name}}"
echo "Done"